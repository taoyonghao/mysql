{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- å·¦ä¾§ï¼šåŠŸèƒ½é¢æ¿ -->
    <div class="col-md-4">
        <!-- è´¢åŠ¡çŠ¶æ€å¡ç‰‡ -->
        <div class="card dashboard-card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>å½“å‰è´¢åŠ¡çŠ¶æ€</h5>
            </div>
            <div class="card-body">
                {% if has_data %}
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="text-success">
                            <div class="display-6">Â¥ {{ "%.2f"|format(monthly_income) }}</div>
                            <small class="text-muted">æœ¬æœˆæ”¶å…¥</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="text-danger">
                            <div class="display-6">Â¥ {{ "%.2f"|format(monthly_expense) }}</div>
                            <small class="text-muted">æœ¬æœˆæ”¯å‡º</small>
                        </div>
                    </div>
                </div>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>æ•°æ®å°±ç»ª</strong> - AIå¯ä»¥åŸºäºæ‚¨çš„ {{ monthly_income + monthly_expense }} å…ƒæµæ°´è¿›è¡Œåˆ†æ
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">æš‚æ— æ•°æ®</h5>
                    <p class="text-muted small">è¯·å…ˆæ·»åŠ æ”¶æ”¯è®°å½•ï¼ŒAIæ‰èƒ½è¿›è¡Œåˆ†æ</p>
                    <a href="{{ url_for('add_record') }}" class="btn btn-primary mt-2">
                        <i class="fas fa-plus me-2"></i>æ·»åŠ è®°å½•
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- AIåŠŸèƒ½å¡ç‰‡ -->
        <div class="card dashboard-card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AIåˆ†æåŠŸèƒ½</h5>
            </div>
            <div class="card-body">
                {% if has_data %}
                <div class="d-grid gap-2">
                    <button id="btnAnalyze" class="btn btn-primary btn-lg py-3" onclick="analyzeBills()">
                        <i class="fas fa-chart-pie me-2"></i>æ™ºèƒ½è´¦å•åˆ†æ
                        <span class="badge bg-white text-primary ms-2">æ¨è</span>
                    </button>

                    <div class="dropdown mt-2">
                        <button class="btn btn-success w-100 py-3 dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" {% if not has_data %}disabled{% endif %}>
                            <i class="fas fa-bullseye me-2"></i>è´¢åŠ¡è§„åˆ’å»ºè®®
                        </button>
                        <ul class="dropdown-menu w-100">
                            <li><a class="dropdown-item" href="#" onclick="getPlan('ä¸€èˆ¬å‚¨è“„è§„åˆ’')">
                                <i class="fas fa-piggy-bank me-2"></i>ä¸€èˆ¬å‚¨è“„è§„åˆ’
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="getPlan('æ—…è¡ŒåŸºé‡‘è§„åˆ’')">
                                <i class="fas fa-plane me-2"></i>æ—…è¡ŒåŸºé‡‘è§„åˆ’
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="getPlan('ç´§æ€¥å¤‡ç”¨é‡‘è§„åˆ’')">
                                <i class="fas fa-shield-alt me-2"></i>ç´§æ€¥å¤‡ç”¨é‡‘è§„åˆ’
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="getPlan('æŠ•èµ„ç†è´¢è§„åˆ’')">
                                <i class="fas fa-chart-line me-2"></i>æŠ•èµ„ç†è´¢è§„åˆ’
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#customPlanModal">
                                <i class="fas fa-edit me-2"></i>è‡ªå®šä¹‰è§„åˆ’ç›®æ ‡
                            </a></li>
                        </ul>
                    </div>
                </div>

                <div class="mt-4">
                    <h6><i class="fas fa-question-circle me-2"></i>å¿«æ·æé—®</h6>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <button class="btn btn-outline-info btn-sm" onclick="askQuestion('å¦‚ä½•çœé’±ï¼Ÿ')">å¦‚ä½•çœé’±ï¼Ÿ</button>
                        <button class="btn btn-outline-info btn-sm" onclick="askQuestion('æˆ‘çš„æ¶ˆè´¹åˆç†å—ï¼Ÿ')">æ¶ˆè´¹åˆç†å—ï¼Ÿ</button>
                        <button class="btn btn-outline-info btn-sm" onclick="askQuestion('æ€æ ·åˆ¶å®šé¢„ç®—ï¼Ÿ')">åˆ¶å®šé¢„ç®—</button>
                        <button class="btn btn-outline-info btn-sm" onclick="askQuestion('æœ‰å“ªäº›çœé’±æŠ€å·§ï¼Ÿ')">çœé’±æŠ€å·§</button>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    è¯·å…ˆæ·»åŠ æ”¶æ”¯è®°å½•ï¼Œæ‰èƒ½ä½¿ç”¨AIåŠŸèƒ½
                </div>
                {% endif %}
            </div>
        </div>

        <!-- APIçŠ¶æ€å¡ç‰‡ -->
        <div class="card dashboard-card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-plug me-2"></i>æœåŠ¡çŠ¶æ€</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>DeepSeek API</span>
                    <span class="badge bg-success" id="apiStatus">æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>æ•°æ®åº“è¿æ¥</span>
                    <span class="badge bg-success">æ­£å¸¸</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>AIæœåŠ¡å“åº”</span>
                    <span class="badge bg-secondary">å¾…æµ‹è¯•</span>
                </div>

                <hr class="my-3">

                <button class="btn btn-outline-info btn-sm w-100" onclick="testAIService()">
                    <i class="fas fa-bolt me-2"></i>æµ‹è¯•AIè¿æ¥
                </button>

                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    ä½¿ç”¨DeepSeekå®˜æ–¹APIï¼Œå“åº”æ—¶é—´çº¦5-10ç§’
                </small>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šAIå¯¹è¯åŒºåŸŸ -->
    <div class="col-md-8">
        <!-- AIå¯¹è¯ä¸»åŒºåŸŸ -->
        <div class="card dashboard-card mb-4" style="height: 500px;">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comments me-2"></i>AIè´¢åŠ¡é¡¾é—®</h5>
                <div>
                    <span class="badge bg-light text-primary">DeepSeek AI</span>
                    <button class="btn btn-sm btn-light ms-2" onclick="clearChat()">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0 d-flex flex-column">
                <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="chatMessages" class="flex-grow-1 p-3 overflow-auto"
                     style="max-height: 350px; min-height: 350px;">
                    <div class="text-center text-muted py-5" id="welcomeMessage">
                        <div class="ai-welcome-icon mb-3">
                            <i class="fas fa-robot fa-4x text-primary"></i>
                        </div>
                        <h4 class="text-primary mb-3">ğŸ¤– AIè´¢åŠ¡é¡¾é—®å·²å°±ç»ª</h4>
                        <p class="mb-4">åŸºäºDeepSeek AIæŠ€æœ¯ï¼Œä¸ºæ‚¨æä¾›ä¸“ä¸šçš„è´¢åŠ¡åˆ†æå’Œè§„åˆ’å»ºè®®</p>

                        {% if has_data %}
                        <div class="d-flex justify-content-center gap-3">
                            <button class="btn btn-primary" onclick="analyzeBills()">
                                <i class="fas fa-chart-pie me-2"></i>å¼€å§‹è´¦å•åˆ†æ
                            </button>
                            <button class="btn btn-outline-primary" onclick="askQuestion('ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ çš„åŠŸèƒ½')">
                                <i class="fas fa-question me-2"></i>æ‰“ä¸ªæ‹›å‘¼
                            </button>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            è¯·å…ˆæ·»åŠ æ”¶æ”¯è®°å½•ï¼ŒAIæ‰èƒ½ä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–åˆ†æ
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="border-top p-3 bg-light">
                    <div class="input-group">
                        <input type="text" id="chatInput" class="form-control border-primary"
                               placeholder="è¾“å…¥æ‚¨çš„è´¢åŠ¡é—®é¢˜ï¼ˆä¾‹å¦‚ï¼šå¦‚ä½•åˆ¶å®šé¢„ç®—ï¼Ÿï¼‰..."
                               {% if not has_data %}disabled{% endif %}>
                        <button class="btn btn-primary" onclick="sendMessage()" {% if not has_data %}disabled{% endif %}>
                            <i class="fas fa-paper-plane"></i> å‘é€
                        </button>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">
                            <i class="fas fa-keyboard me-1"></i>æŒ‰ Enter å‘é€
                        </small>
                        <small class="text-muted">
                            <i class="fas fa-bolt me-1"></i>Powered by DeepSeek AI
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†æå†å² -->
        <div class="card dashboard-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>åˆ†æå†å²</h5>
                <span class="badge bg-primary">{{ history|length }} æ¡è®°å½•</span>
            </div>
            <div class="card-body p-0">
                {% if history %}
                    <div class="list-group list-group-flush">
                        {% for item in history %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <div class="mb-1">
                                    <span class="badge
                                        {% if item.analysis_type == 'è´¦å•åˆ†æ' %}bg-primary
                                        {% elif item.analysis_type == 'è´¢åŠ¡è§„åˆ’' %}bg-success
                                        {% else %}bg-info{% endif %} me-2">
                                        {{ item.analysis_type }}
                                    </span>
                                    <small class="text-muted">
                                        {{ item.created_at.strftime('%m-%d %H:%M') if item.created_at else '' }}
                                    </small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary"
                                            onclick="viewHistoryDetail({{ item.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="{{ url_for('ai_delete', analysis_id=item.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </div>
                            <p class="mb-1 text-truncate">
                                {% if item.user_input %}
                                    {{ item.user_input[:50] }}{% if item.user_input|length > 50 %}...{% endif %}
                                {% else %}
                                    <span class="text-muted">æ— è¾“å…¥å†…å®¹</span>
                                {% endif %}
                            </p>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">æš‚æ— åˆ†æå†å²è®°å½•</p>
                        <p class="text-muted small">ä½¿ç”¨AIåŠŸèƒ½åï¼Œå†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- è‡ªå®šä¹‰è§„åˆ’æ¨¡æ€æ¡† -->
<div class="modal fade" id="customPlanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-bullseye me-2"></i>è‡ªå®šä¹‰è§„åˆ’ç›®æ ‡</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="customTarget" class="form-label">è¯·è¾“å…¥æ‚¨çš„è´¢åŠ¡ç›®æ ‡ï¼š</label>
                    <input type="text" class="form-control" id="customTarget"
                           placeholder="ä¾‹å¦‚ï¼š6ä¸ªæœˆå†…å­˜å¤Ÿ3ä¸‡å…ƒæ—…æ¸¸åŸºé‡‘">
                    <div class="form-text">è¯·å°½é‡å…·ä½“æè¿°æ‚¨çš„ç›®æ ‡ï¼ŒAIä¼šä¸ºæ‚¨åˆ¶å®šè¯¦ç»†çš„è§„åˆ’ã€‚</div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>æç¤ºï¼š</strong> AIä¼šæ ¹æ®æ‚¨è®¾å®šçš„ç›®æ ‡ï¼Œç»“åˆæ‚¨çš„æ”¶æ”¯æƒ…å†µï¼Œåˆ¶å®šè¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’å’Œé¢„ç®—æ–¹æ¡ˆã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="submitCustomPlan()">å¼€å§‹è§„åˆ’</button>
            </div>
        </div>
    </div>
</div>

<!-- å†å²è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>åˆ†æè¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="historyContent" class="p-3 bg-light rounded"
                     style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="copyHistoryContent()">
                    <i class="fas fa-copy me-2"></i>å¤åˆ¶å†…å®¹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½åŠ¨ç”» -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 bg-transparent">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <h5 class="text-white mt-3" id="loadingText">AIæ­£åœ¨æ€è€ƒ...</h5>
                <p class="text-white-50 small mt-2">è¿™å¯èƒ½éœ€è¦10-20ç§’</p>
            </div>
        </div>
    </div>
</div>

<style>
    .chat-message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 15px;
        max-width: 85%;
        animation: fadeIn 0.3s;
    }
    .user-message {
        background-color: #e3f2fd;
        margin-left: auto;
        border-bottom-right-radius: 5px;
        border: 1px solid #bbdefb;
    }
    .ai-message {
        background-color: #f5f5f5;
        margin-right: auto;
        border-bottom-left-radius: 5px;
        border: 1px solid #e0e0e0;
    }
    .message-header {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 0.9em;
    }
    .message-content {
        line-height: 1.5;
    }
    .message-time {
        font-size: 0.75em;
        color: #888;
        margin-top: 8px;
        text-align: right;
    }
    #chatMessages::-webkit-scrollbar {
        width: 8px;
    }
    #chatMessages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    #chatMessages::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    #chatMessages::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    .typing-indicator {
        display: inline-flex;
        align-items: center;
        padding: 10px 15px;
        background-color: #f5f5f5;
        border-radius: 15px;
    }
    .typing-dot {
        width: 8px;
        height: 8px;
        background-color: #6c757d;
        border-radius: 50%;
        margin: 0 3px;
        animation: typing 1.4s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .ai-welcome-icon {
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
</style>

<script>
// ==================== å…¨å±€å˜é‡å’Œå·¥å…·å‡½æ•° ====================
let isProcessing = false;

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(content, isUser = false) {
    const chatMessages = document.getElementById('chatMessages');
    const welcomeMessage = document.getElementById('welcomeMessage');

    if (welcomeMessage) {
        welcomeMessage.classList.add('d-none');
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${isUser ? 'user-message' : 'ai-message'}`;

    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    if (isUser) {
        messageDiv.innerHTML = `
            <div class="message-header">
                <i class="fas fa-user me-2 text-primary"></i>æ‚¨
            </div>
            <div class="message-content">${escapeHtml(content)}</div>
            <div class="message-time">${time}</div>
        `;
    } else {
        // æ ¼å¼åŒ–AIå›å¤ï¼ˆç®€å•çš„Markdownè½¬æ¢ï¼‰
        let formattedContent = formatAIMessage(content);

        messageDiv.innerHTML = `
            <div class="message-header">
                <i class="fas fa-robot me-2 text-success"></i>AIè´¢åŠ¡é¡¾é—®
            </div>
            <div class="message-content">${formattedContent}</div>
            <div class="message-time">${time}</div>
        `;
    }

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const welcomeMessage = document.getElementById('welcomeMessage');

    if (welcomeMessage) {
        welcomeMessage.classList.add('d-none');
    }

    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message ai-message';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div class="message-header">
            <i class="fas fa-robot me-2 text-success"></i>AIè´¢åŠ¡é¡¾é—®
        </div>
        <div class="typing-indicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
        <div class="message-time">æ€è€ƒä¸­...</div>
    `;

    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ç§»é™¤æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// æ ¼å¼åŒ–AIæ¶ˆæ¯ï¼ˆç®€å•Markdownè½¬HTMLï¼‰
function formatAIMessage(text) {
    if (!text) return '';

    return text
        // è½¬ä¹‰HTML
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        // æ ‡é¢˜
        .replace(/^### (.*$)/gm, '<h6 class="mt-3 mb-2 fw-bold">$1</h6>')
        .replace(/^## (.*$)/gm, '<h5 class="mt-3 mb-2 fw-bold border-bottom pb-1">$1</h5>')
        .replace(/^# (.*$)/gm, '<h4 class="mt-3 mb-3 fw-bold text-primary">$1</h4>')
        // ç²—ä½“
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // æ–œä½“
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // åˆ—è¡¨
        .replace(/^(\d+)\./gm, '<br><strong>$1.</strong>')
        .replace(/^[-*] (.*$)/gm, '<br>â€¢ $1')
        // æ¢è¡Œ
        .replace(/\n/g, '<br>')
        // ä»£ç å—
        .replace(/`([^`]+)`/g, '<code class="bg-light p-1 rounded">$1</code>')
        // é«˜äº®é‡è¦ä¿¡æ¯
        .replace(/é‡è¦ï¼š/g, '<span class="text-danger fw-bold">é‡è¦ï¼š</span>')
        .replace(/å»ºè®®ï¼š/g, '<span class="text-success fw-bold">å»ºè®®ï¼š</span>')
        .replace(/æ³¨æ„ï¼š/g, '<span class="text-warning fw-bold">æ³¨æ„ï¼š</span>');
}

// HTMLè½¬ä¹‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ˜¾ç¤ºåŠ è½½æ¨¡æ€æ¡†
function showLoading(text = 'AIæ­£åœ¨æ€è€ƒ...') {
    document.getElementById('loadingText').textContent = text;
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    isProcessing = true;
}

// éšè—åŠ è½½æ¨¡æ€æ¡†
function hideLoading() {
    const loadingModal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (loadingModal) {
        loadingModal.hide();
    }
    isProcessing = false;
}

// ==================== AIåŠŸèƒ½å‡½æ•° ====================

// æ™ºèƒ½è´¦å•åˆ†æ
async function analyzeBills() {
    if (isProcessing) return;

    showMessage("è¯·åˆ†ææˆ‘çš„è´¦å•æƒ…å†µ", true);
    showLoading("æ­£åœ¨åˆ†ææ‚¨çš„è´¦å•æ•°æ®...");

    try {
        const response = await fetch('/ai_analyze_bills', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            showMessage(data.analysis);
        } else {
            showMessage(`âŒ ${data.message || 'åˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚'}`);
        }
    } catch (error) {
        console.error('åˆ†æå¤±è´¥:', error);
        showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•ã€‚');
    } finally {
        hideLoading();
    }
}

// è·å–è´¢åŠ¡è§„åˆ’
async function getPlan(target) {
    if (isProcessing) return;

    showMessage(`è¯·å¸®æˆ‘åˆ¶å®š${target}`, true);
    showLoading(`æ­£åœ¨åˆ¶å®š${target}...`);

    try {
        const response = await fetch('/ai_financial_plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ target: target })
        });

        const data = await response.json();

        if (data.success) {
            showMessage(data.plan);
        } else {
            showMessage(`âŒ ${data.message || 'è§„åˆ’å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚'}`);
        }
    } catch (error) {
        console.error('è§„åˆ’å¤±è´¥:', error);
        showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•ã€‚');
    } finally {
        hideLoading();
    }
}

// æäº¤è‡ªå®šä¹‰è§„åˆ’
function submitCustomPlan() {
    const customTarget = document.getElementById('customTarget').value.trim();
    if (!customTarget) {
        alert('è¯·è¾“å…¥è§„åˆ’ç›®æ ‡');
        return;
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('customPlanModal'));
    if (modal) {
        modal.hide();
    }

    document.getElementById('customTarget').value = '';
    getPlan(customTarget);
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    if (isProcessing) return;

    const input = document.getElementById('chatInput');
    const message = input.value.trim();

    if (!message) return;

    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    showMessage(message, true);
    input.value = '';

    // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
    showTypingIndicator();
    isProcessing = true;

    try {
        const response = await fetch('/ai_chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        });

        const data = await response.json();

        // ç§»é™¤æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        removeTypingIndicator();

        if (data.success) {
            showMessage(data.response);
        } else {
            showMessage(`âŒ ${data.message || 'å›ç­”å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚'}`);
        }
    } catch (error) {
        console.error('å‘é€å¤±è´¥:', error);
        removeTypingIndicator();
        showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•ã€‚');
    } finally {
        isProcessing = false;
    }
}

// å¿«æ·æé—®
function askQuestion(question) {
    document.getElementById('chatInput').value = question;
    sendMessage();
}

// æŸ¥çœ‹å†å²è¯¦æƒ…
async function viewHistoryDetail(id) {
    showLoading('åŠ è½½åˆ†æè¯¦æƒ…...');

    try {
        const response = await fetch(`/api/ai_detail/${id}`);
        const data = await response.json();

        if (data.success) {
            const content = formatAIMessage(data.response);
            document.getElementById('historyContent').innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
        } else {
            alert(data.message || 'åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        alert('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    } finally {
        hideLoading();
    }
}

// å¤åˆ¶å†å²å†…å®¹
function copyHistoryContent() {
    const content = document.getElementById('historyContent').textContent;
    navigator.clipboard.writeText(content)
        .then(() => alert('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
        .catch(err => console.error('å¤åˆ¶å¤±è´¥:', err));
}

// æ¸…ç©ºèŠå¤©
function clearChat() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) return;

    const chatMessages = document.getElementById('chatMessages');
    const welcomeMessage = document.getElementById('welcomeMessage');

    // ä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼Œç§»é™¤å…¶ä»–æ¶ˆæ¯
    Array.from(chatMessages.children).forEach(child => {
        if (child.id !== 'welcomeMessage') {
            child.remove();
        }
    });

    if (welcomeMessage) {
        welcomeMessage.classList.remove('d-none');
    }
}

// æµ‹è¯•AIæœåŠ¡
async function testAIService() {
    const apiStatus = document.getElementById('apiStatus');
    apiStatus.className = 'badge bg-warning';
    apiStatus.textContent = 'æµ‹è¯•ä¸­...';

    try {
        const response = await fetch('/ai_test');
        const data = await response.json();

        if (data.success) {
            apiStatus.className = 'badge bg-success';
            apiStatus.textContent = 'æ­£å¸¸';

            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            showMessage(`âœ… ${data.message}<br><small>å“åº”: ${data.response}</small>`);
        } else {
            apiStatus.className = 'badge bg-danger';
            apiStatus.textContent = 'å¼‚å¸¸';

            showMessage(`âŒ ${data.message}<br><small>é”™è¯¯: ${data.error}</small>`);
        }
    } catch (error) {
        apiStatus.className = 'badge bg-danger';
        apiStatus.textContent = 'è¿æ¥å¤±è´¥';

        console.error('æµ‹è¯•å¤±è´¥:', error);
        showMessage('âŒ æ— æ³•è¿æ¥åˆ°AIæœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
    }
}

// ==================== é¡µé¢åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', function() {
    // è¾“å…¥æ¡†å›è½¦å‘é€
    const chatInput = document.getElementById('chatInput');
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // è‡ªåŠ¨æµ‹è¯•AIè¿æ¥
    setTimeout(testAIService, 1000);

    // æ£€æŸ¥æ•°æ®çŠ¶æ€
    {% if not has_data %}
    document.getElementById('chatInput').placeholder = 'è¯·å…ˆæ·»åŠ æ”¶æ”¯è®°å½•æ‰èƒ½ä½¿ç”¨AIåŠŸèƒ½...';
    {% endif %}
});
</script>
{% endblock %}